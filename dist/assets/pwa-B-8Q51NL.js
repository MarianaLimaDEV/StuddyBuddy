import{o as W}from"./vendor-Dob3nYDb.js";import{s as p,t as c}from"./utils-C9v_kkLp.js";const D="studdybuddy",L=`${D}-db`,C=3,j="sync-pending",P=(import.meta?.env?.VITE_API_BASE_URL||"").trim(),m=P?P.replace(/\/+$/,""):"";function R(t){return/^https?:\/\//i.test(t)}function w(t){const e=String(t||"");return!m||R(e)?e:e.startsWith("/")?`${m}${e}`:`${m}/${e}`}function f(t,e){return fetch(w(t),e)}const s=W(L,C,{upgrade(t,e,n){t.objectStoreNames.contains("tasks")||t.createObjectStore("tasks",{keyPath:"_id"}),t.objectStoreNames.contains("dados")||t.createObjectStore("dados",{keyPath:"_id"}),t.objectStoreNames.contains("pendingSync")||t.createObjectStore("pendingSync",{keyPath:"syncId",autoIncrement:!0}).createIndex("byTimestamp","timestamp",{unique:!1})}});async function ct(t,e){return(await s).put(t,e)}async function dt(t,e){return(await s).get(t,e)}async function M(t,e){const n=Array.isArray(e)?e:[],r=(await s).transaction(t,"readwrite");await r.store.clear();for(const i of n)await r.store.put(i);await r.done}async function U(t){return(await s).getAll(t)}async function ut(t,e){return(await s).delete(t,e)}async function lt(t){await(await s).add("pendingSync",{type:t.type,url:t.url,body:t.body??null,taskId:t.id??null,headers:t.headers??null,timestamp:Date.now()})}async function $(){return await(await s).getAllFromIndex("pendingSync","byTimestamp")}async function B(t){return(await s).delete("pendingSync",t)}async function V(){const t=new AbortController,e=setTimeout(()=>t.abort(),8e3);try{const n=await f("/api/tasks",{signal:t.signal});if(clearTimeout(e),!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json(),r=Array.isArray(a)?a:[];return await M("tasks",r),r}catch(n){return clearTimeout(e),console.error("carregarTasks fetch failed:",n),await U("tasks")}}let b=!1;async function H(){const t=await $();if(t.length!==0)for(const e of t)try{const n=new Headers(e.headers||{});n.has("Content-Type")||n.set("Content-Type","application/json");const a={method:e.type,headers:n};e.body&&(e.type==="POST"||e.type==="PUT")&&(a.body=JSON.stringify(e.body));const r=await f(e.url,a);r.ok?await B(e.syncId??e.id):r.status>=400&&r.status<500&&(console.warn(`Sync failed with client error ${r.status}, removing item:`,e),await B(e.syncId??e.id))}catch(n){console.warn("Sync item failed, will retry later:",e,n)}}async function h(){if(b){console.debug("Sync already in progress, skipping");return}b=!0;try{await H(),await V(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("pwa-synced"))}finally{b=!1}}async function ft(){if(typeof navigator>"u"||!navigator.serviceWorker)return;const t=await navigator.serviceWorker.ready;if(!(!t.sync||typeof t.sync.register!="function"))try{await t.sync.register(j)}catch(e){console.warn("Background Sync register failed:",e)}}function pt(){typeof window>"u"||(window.addEventListener("online",()=>{h().catch(()=>{})}),navigator.serviceWorker?.addEventListener("message",t=>{t.data?.type==="SYNC_PENDING"&&h().catch(()=>{})}),navigator.onLine&&h().catch(()=>{}))}const x="/service-worker.js",O="/";function yt(){if(!("serviceWorker"in navigator))return;navigator.serviceWorker.register(x,{scope:O}).then(e=>{console.info("Service Worker registado",e.scope),e.addEventListener("updatefound",()=>{const n=e.installing;n&&n.addEventListener("statechange",()=>{n.state==="installed"&&navigator.serviceWorker.controller&&typeof window.__pwaOnNewVersion=="function"&&window.__pwaOnNewVersion()})})}).catch(e=>console.warn("Erro no registo do Service Worker",e));let t=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{t||(t=!0,window.location.reload())})}async function wt(){if(!navigator.serviceWorker)return console.warn("Service Workers not supported"),!1;try{const t=await navigator.serviceWorker.getRegistration(O);return!t||!t.waiting?!1:(t.waiting.postMessage({type:"SKIP_WAITING"}),!0)}catch(t){throw console.error("Error in skipWaitingAndReload:",t),t}}const T="pwa-install-dismissed";let d=null,S=!1;const I=new Set;function y(){return typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://")}function k(t){S=!!t,I.forEach(e=>{try{e(S)}catch{}})}function G(t){if(typeof t!="function")return()=>{};I.add(t);try{t(S)}catch{}return()=>I.delete(t)}function K(){try{return localStorage.getItem(T)==="1"}catch{return!1}}function E(){try{localStorage.setItem(T,"1")}catch{}}function F(t){t&&(t.classList.remove("hidden"),t.removeAttribute("hidden"),t.removeAttribute("inert"),t.setAttribute("aria-hidden","false"))}function A(t){t&&(t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),t.setAttribute("inert",""))}async function _({hideBannerId:t}={}){if(!d)return{available:!1,outcome:null};try{d.prompt();const n=(await d.userChoice)?.outcome||null;if(n==="accepted"&&E(),d=null,k(!1),t){const a=document.getElementById(t);A(a)}return{available:!0,outcome:n}}catch(e){return{available:!!d,outcome:null,error:e}}}function gt(t={}){const e=t.bannerId??"pwa-install-banner",n=t.installBtnId??"pwa-install-btn",a=t.closeBtnId??"pwa-install-close";if(typeof window>"u"||y())return;const r=!K();window.addEventListener("beforeinstallprompt",o=>{o.preventDefault(),d=o;const l=document.getElementById(e);k(!0),r&&F(l)});const i=document.getElementById(n);i&&i.addEventListener("click",async()=>{await _({hideBannerId:e})});const u=document.getElementById(a);u&&u.addEventListener("click",()=>{E();const o=document.getElementById(e);A(o)}),window.addEventListener("appinstalled",()=>{E(),d=null,k(!1);const o=document.getElementById(e);A(o)})}function J(){const t=navigator.userAgent||"",e=navigator.platform||"",n=/iPad|iPhone|iPod/.test(t),a=e==="MacIntel"&&navigator.maxTouchPoints>1;return n||a}function v(t,e){t&&(t.textContent=e)}function mt(t={}){const e=t.downloadBtnId??"pwaDownloadBtn",n=t.hintId??"pwaInstallHint",a=document.getElementById(e),r=document.getElementById(n),i=()=>{a&&(a.disabled=!0),v(r,c("appAlreadyInstalled"))},u=()=>{a&&(a.disabled=!1),v(r,c("appInstallHint"))},o=()=>{a&&(a.disabled=!1),v(r,c("appInstallReady"))};if(y()){i();return}u(),G(l=>{if(y())return i();l?o():u()}),a?.addEventListener("click",async l=>{l.preventDefault();const g=await _({hideBannerId:"pwa-install-banner"});if(g.available){g.outcome==="accepted"?p(c("appInstalled"),"success",3500):g.outcome==="dismissed"&&p(c("appInstallDismissed"),"info",3500);return}J()?p(c("appInstallIosHint"),"info",7e3):p(c("appInstallDesktopHint"),"info",7e3)})}const q="#171922",Y="#f0f0f4";function z(){typeof document>"u"||(y()?document.documentElement.classList.add("pwa-standalone"):document.documentElement.classList.remove("pwa-standalone"))}function N(){const t=document.querySelector('meta[name="theme-color"]');if(!t)return;const e=document.body.getAttribute("data-theme");t.setAttribute("content",e==="light"?Y:q)}function bt(){z(),N(),new MutationObserver(e=>{e.forEach(n=>{n.attributeName==="data-theme"&&N()})}).observe(document.body,{attributes:!0})}const Q=w("/api/push/vapid-public"),X=w("/api/push/subscribe"),Z=w("/api/push/unsubscribe");async function tt(){const t=await f(Q);if(!t.ok)throw new Error("VAPID public key not available");const e=await t.json(),n=e.publicKey||e.public_key;if(!n)throw new Error("Invalid VAPID response");return n}function et(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/-/g,"+").replace(/_/g,"/"),a=atob(n),r=new Uint8Array(a.length);for(let i=0;i<a.length;i++)r[i]=a.charCodeAt(i);return r}async function nt(t){const e=await tt(),n=et(e);return await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n})}async function at(t,e=null){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);const a=await f(X,{method:"POST",headers:n,body:JSON.stringify(t.toJSON?t.toJSON():t)});if(!a.ok){const r=await a.json().catch(()=>({}));throw new Error(r.message||`Subscribe failed: ${a.status}`)}return a.json()}async function rt(t,e=null){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);const a=await f(Z,{method:"POST",headers:n,body:JSON.stringify({endpoint:t})});if(!a.ok){const r=await a.json().catch(()=>({}));throw new Error(r.message||`Unsubscribe failed: ${a.status}`)}return a.json()}async function it(){return"Notification"in self?Notification.permission==="granted"?"granted":Notification.permission==="denied"?"denied":await Notification.requestPermission():"unsupported"}async function ht(t={}){const{getAuthToken:e}=t;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const n=await it();if(n!=="granted")return{ok:!1,reason:n};try{const a=await navigator.serviceWorker.ready,r=await nt(a),i=typeof e=="function"?await e():null;return await at(r,i),{ok:!0,subscription:r}}catch(a){return console.warn("Push init failed",a),{ok:!1,reason:a.message}}}async function vt(t={}){const{getAuthToken:e}=t;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const a=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!a)return{ok:!0,removed:!1};const r=a.endpoint;try{await a.unsubscribe()}catch{}const i=typeof e=="function"?await e():null;return await rt(r,i).catch(()=>{}),{ok:!0,removed:!0}}async function St(){return!("serviceWorker"in navigator)||!("PushManager"in window)?!1:!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}export{lt as a,w as b,f as c,V as d,ut as e,wt as f,dt as g,pt as h,yt as i,gt as j,mt as k,bt as l,St as m,vt as n,ht as o,ft as r,ct as s};
