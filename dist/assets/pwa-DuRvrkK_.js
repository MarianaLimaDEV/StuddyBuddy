import{o as m}from"./vendor-Dob3nYDb.js";const b="studdybuddy",h=`${b}-db`,v=3,S="sync-pending",o=m(h,v,{upgrade(e,t,n){e.objectStoreNames.contains("tasks")||e.createObjectStore("tasks",{keyPath:"_id"}),e.objectStoreNames.contains("dados")||e.createObjectStore("dados",{keyPath:"_id"}),e.objectStoreNames.contains("pendingSync")||e.createObjectStore("pendingSync",{keyPath:"syncId",autoIncrement:!0}).createIndex("byTimestamp","timestamp",{unique:!1})}});async function H(e,t){return(await o).put(e,t)}async function J(e,t){return(await o).get(e,t)}async function k(e,t){const n=Array.isArray(t)?t:[],r=(await o).transaction(e,"readwrite");await r.store.clear();for(const i of n)await r.store.put(i);await r.done}async function E(e){return(await o).getAll(e)}async function K(e,t){return(await o).delete(e,t)}async function q(e){await(await o).add("pendingSync",{type:e.type,url:e.url,body:e.body??null,taskId:e.id??null,headers:e.headers??null,timestamp:Date.now()})}async function P(){return await(await o).getAllFromIndex("pendingSync","byTimestamp")}async function f(e){return(await o).delete("pendingSync",e)}async function I(){const e=new AbortController,t=setTimeout(()=>e.abort(),8e3);try{const n=await fetch("/api/tasks",{signal:e.signal});if(clearTimeout(t),!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json(),r=Array.isArray(a)?a:[];return await k("tasks",r),r}catch(n){return clearTimeout(t),console.error("carregarTasks fetch failed:",n),await E("tasks")}}let d=!1;async function N(){const e=await P();if(e.length!==0)for(const t of e)try{const n=new Headers(t.headers||{});n.has("Content-Type")||n.set("Content-Type","application/json");const a={method:t.type,headers:n};t.body&&(t.type==="POST"||t.type==="PUT")&&(a.body=JSON.stringify(t.body));const r=await fetch(t.url,a);r.ok?await f(t.syncId??t.id):r.status>=400&&r.status<500&&(console.warn(`Sync failed with client error ${r.status}, removing item:`,t),await f(t.syncId??t.id))}catch(n){console.warn("Sync item failed, will retry later:",t,n)}}async function u(){if(d){console.debug("Sync already in progress, skipping");return}d=!0;try{await N(),await I(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("pwa-synced"))}finally{d=!1}}async function x(){if(typeof navigator>"u"||!navigator.serviceWorker)return;const e=await navigator.serviceWorker.ready;if(!(!e.sync||typeof e.sync.register!="function"))try{await e.sync.register(S)}catch(t){console.warn("Background Sync register failed:",t)}}function F(){typeof window>"u"||(window.addEventListener("online",()=>{u().catch(()=>{})}),navigator.serviceWorker?.addEventListener("message",e=>{e.data?.type==="SYNC_PENDING"&&u().catch(()=>{})}),navigator.onLine&&u().catch(()=>{}))}const A="./service-worker.js",O="./";function Y(){if(!("serviceWorker"in navigator))return;navigator.serviceWorker.register(A,{scope:O}).then(t=>{console.info("Service Worker registado",t.scope),t.addEventListener("updatefound",()=>{const n=t.installing;n&&n.addEventListener("statechange",()=>{n.state==="installed"&&navigator.serviceWorker.controller&&typeof window.__pwaOnNewVersion=="function"&&window.__pwaOnNewVersion()})})}).catch(t=>console.warn("Erro no registo do Service Worker",t));let e=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(e=!0,window.location.reload())})}const p="pwa-install-dismissed";function g(){return typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://")}function T(){try{return localStorage.getItem(p)==="1"}catch{return!1}}function y(){try{localStorage.setItem(p,"1")}catch{}}function z(e={}){const t=e.bannerId??"pwa-install-banner",n=e.installBtnId??"pwa-install-btn",a=e.closeBtnId??"pwa-install-close";if(g()||T())return;let r=null;window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),r=s;const c=document.getElementById(t);c&&(c.classList.remove("hidden"),c.setAttribute("aria-hidden","false"))});const i=document.getElementById(n);i&&i.addEventListener("click",async()=>{if(!r)return;r.prompt();const{outcome:s}=await r.userChoice;s==="accepted"&&y(),r=null;const c=document.getElementById(t);c&&(c.classList.add("hidden"),c.setAttribute("aria-hidden","true"))});const l=document.getElementById(a);l&&l.addEventListener("click",()=>{y();const s=document.getElementById(t);s&&(s.classList.add("hidden"),s.setAttribute("aria-hidden","true"))})}const B="#171922",_="#f0f0f4";function L(){typeof document>"u"||(g()?document.documentElement.classList.add("pwa-standalone"):document.documentElement.classList.remove("pwa-standalone"))}function w(){const e=document.querySelector('meta[name="theme-color"]');if(!e)return;const t=document.body.getAttribute("data-theme");e.setAttribute("content",t==="light"?_:B)}function Q(){L(),w(),new MutationObserver(t=>{t.forEach(n=>{n.attributeName==="data-theme"&&w()})}).observe(document.body,{attributes:!0})}const C="/api/push/vapid-public",W="/api/push/subscribe",j="/api/push/unsubscribe";async function D(){const e=await fetch(C);if(!e.ok)throw new Error("VAPID public key not available");const t=await e.json(),n=t.publicKey||t.public_key;if(!n)throw new Error("Invalid VAPID response");return n}function M(e){const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/-/g,"+").replace(/_/g,"/"),a=atob(n),r=new Uint8Array(a.length);for(let i=0;i<a.length;i++)r[i]=a.charCodeAt(i);return r}async function V(e){const t=await D(),n=M(t);return await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n})}async function R(e,t=null){const n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);const a=await fetch(W,{method:"POST",headers:n,body:JSON.stringify(e.toJSON?e.toJSON():e)});if(!a.ok){const r=await a.json().catch(()=>({}));throw new Error(r.message||`Subscribe failed: ${a.status}`)}return a.json()}async function U(e,t=null){const n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);const a=await fetch(j,{method:"POST",headers:n,body:JSON.stringify({endpoint:e})});if(!a.ok){const r=await a.json().catch(()=>({}));throw new Error(r.message||`Unsubscribe failed: ${a.status}`)}return a.json()}async function $(){return"Notification"in self?Notification.permission==="granted"?"granted":Notification.permission==="denied"?"denied":await Notification.requestPermission():"unsupported"}async function X(e={}){const{getAuthToken:t}=e;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const n=await $();if(n!=="granted")return{ok:!1,reason:n};try{const a=await navigator.serviceWorker.ready,r=await V(a),i=typeof t=="function"?await t():null;return await R(r,i),{ok:!0,subscription:r}}catch(a){return console.warn("Push init failed",a),{ok:!1,reason:a.message}}}async function Z(e={}){const{getAuthToken:t}=e;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const a=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!a)return{ok:!0,removed:!1};const r=a.endpoint;try{await a.unsubscribe()}catch{}const i=typeof t=="function"?await t():null;return await U(r,i).catch(()=>{}),{ok:!0,removed:!0}}async function ee(){return!("serviceWorker"in navigator)||!("PushManager"in window)?!1:!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}export{q as a,K as b,I as c,F as d,z as e,Q as f,J as g,ee as h,Y as i,Z as j,X as k,x as r,H as s};
