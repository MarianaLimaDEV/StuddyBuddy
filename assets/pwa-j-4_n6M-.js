import{o as B}from"./vendor-Dob3nYDb.js";import{s as f,t as c}from"./utils-BT0XPfzc.js";const N="studdybuddy",O=`${N}-db`,T=3,_="sync-pending",s=B(O,T,{upgrade(t,e,n){t.objectStoreNames.contains("tasks")||t.createObjectStore("tasks",{keyPath:"_id"}),t.objectStoreNames.contains("dados")||t.createObjectStore("dados",{keyPath:"_id"}),t.objectStoreNames.contains("pendingSync")||t.createObjectStore("pendingSync",{keyPath:"syncId",autoIncrement:!0}).createIndex("byTimestamp","timestamp",{unique:!1})}});async function at(t,e){return(await s).put(t,e)}async function it(t,e){return(await s).get(t,e)}async function D(t,e){const n=Array.isArray(e)?e:[],i=(await s).transaction(t,"readwrite");await i.store.clear();for(const r of n)await i.store.put(r);await i.done}async function C(t){return(await s).getAll(t)}async function rt(t,e){return(await s).delete(t,e)}async function ot(t){await(await s).add("pendingSync",{type:t.type,url:t.url,body:t.body??null,taskId:t.id??null,headers:t.headers??null,timestamp:Date.now()})}async function L(){return await(await s).getAllFromIndex("pendingSync","byTimestamp")}async function k(t){return(await s).delete("pendingSync",t)}async function W(){const t=new AbortController,e=setTimeout(()=>t.abort(),8e3);try{const n=await fetch("/api/tasks",{signal:t.signal});if(clearTimeout(e),!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json(),i=Array.isArray(a)?a:[];return await D("tasks",i),i}catch(n){return clearTimeout(e),console.error("carregarTasks fetch failed:",n),await C("tasks")}}let w=!1;async function j(){const t=await L();if(t.length!==0)for(const e of t)try{const n=new Headers(e.headers||{});n.has("Content-Type")||n.set("Content-Type","application/json");const a={method:e.type,headers:n};e.body&&(e.type==="POST"||e.type==="PUT")&&(a.body=JSON.stringify(e.body));const i=await fetch(e.url,a);i.ok?await k(e.syncId??e.id):i.status>=400&&i.status<500&&(console.warn(`Sync failed with client error ${i.status}, removing item:`,e),await k(e.syncId??e.id))}catch(n){console.warn("Sync item failed, will retry later:",e,n)}}async function m(){if(w){console.debug("Sync already in progress, skipping");return}w=!0;try{await j(),await W(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("pwa-synced"))}finally{w=!1}}async function st(){if(typeof navigator>"u"||!navigator.serviceWorker)return;const t=await navigator.serviceWorker.ready;if(!(!t.sync||typeof t.sync.register!="function"))try{await t.sync.register(_)}catch(e){console.warn("Background Sync register failed:",e)}}function ct(){typeof window>"u"||(window.addEventListener("online",()=>{m().catch(()=>{})}),navigator.serviceWorker?.addEventListener("message",t=>{t.data?.type==="SYNC_PENDING"&&m().catch(()=>{})}),navigator.onLine&&m().catch(()=>{}))}const M="/service-worker.js",U="/";function dt(){if(!("serviceWorker"in navigator))return;navigator.serviceWorker.register(M,{scope:U}).then(e=>{console.info("Service Worker registado",e.scope),e.addEventListener("updatefound",()=>{const n=e.installing;n&&n.addEventListener("statechange",()=>{n.state==="installed"&&navigator.serviceWorker.controller&&typeof window.__pwaOnNewVersion=="function"&&window.__pwaOnNewVersion()})})}).catch(e=>console.warn("Erro no registo do Service Worker",e));let t=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{t||(t=!0,window.location.reload())})}const P="pwa-install-dismissed";let d=null,b=!1;const h=new Set;function p(){return typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://")}function v(t){b=!!t,h.forEach(e=>{try{e(b)}catch{}})}function R(t){if(typeof t!="function")return()=>{};h.add(t);try{t(b)}catch{}return()=>h.delete(t)}function V(){try{return localStorage.getItem(P)==="1"}catch{return!1}}function S(){try{localStorage.setItem(P,"1")}catch{}}function H(t){t&&(t.classList.remove("hidden"),t.removeAttribute("hidden"),t.removeAttribute("inert"),t.setAttribute("aria-hidden","false"))}function I(t){t&&(t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),t.setAttribute("inert",""))}async function A({hideBannerId:t}={}){if(!d)return{available:!1,outcome:null};try{d.prompt();const n=(await d.userChoice)?.outcome||null;if(n==="accepted"&&S(),d=null,v(!1),t){const a=document.getElementById(t);I(a)}return{available:!0,outcome:n}}catch(e){return{available:!!d,outcome:null,error:e}}}function lt(t={}){const e=t.bannerId??"pwa-install-banner",n=t.installBtnId??"pwa-install-btn",a=t.closeBtnId??"pwa-install-close";if(typeof window>"u"||p())return;const i=!V();window.addEventListener("beforeinstallprompt",o=>{o.preventDefault(),d=o;const u=document.getElementById(e);v(!0),i&&H(u)});const r=document.getElementById(n);r&&r.addEventListener("click",async()=>{await A({hideBannerId:e})});const l=document.getElementById(a);l&&l.addEventListener("click",()=>{S();const o=document.getElementById(e);I(o)}),window.addEventListener("appinstalled",()=>{S(),d=null,v(!1);const o=document.getElementById(e);I(o)})}function $(){const t=navigator.userAgent||"",e=navigator.platform||"",n=/iPad|iPhone|iPod/.test(t),a=e==="MacIntel"&&navigator.maxTouchPoints>1;return n||a}function g(t,e){t&&(t.textContent=e)}function ut(t={}){const e=t.downloadBtnId??"pwaDownloadBtn",n=t.hintId??"pwaInstallHint",a=document.getElementById(e),i=document.getElementById(n),r=()=>{a&&(a.disabled=!0),g(i,c("appAlreadyInstalled"))},l=()=>{a&&(a.disabled=!1),g(i,c("appInstallHint"))},o=()=>{a&&(a.disabled=!1),g(i,c("appInstallReady"))};if(p()){r();return}l(),R(u=>{if(p())return r();u?o():l()}),a?.addEventListener("click",async u=>{u.preventDefault();const y=await A({hideBannerId:"pwa-install-banner"});if(y.available){y.outcome==="accepted"?f(c("appInstalled"),"success",3500):y.outcome==="dismissed"&&f(c("appInstallDismissed"),"info",3500);return}$()?f(c("appInstallIosHint"),"info",7e3):f(c("appInstallDesktopHint"),"info",7e3)})}const x="#171922",G="#f0f0f4";function J(){typeof document>"u"||(p()?document.documentElement.classList.add("pwa-standalone"):document.documentElement.classList.remove("pwa-standalone"))}function E(){const t=document.querySelector('meta[name="theme-color"]');if(!t)return;const e=document.body.getAttribute("data-theme");t.setAttribute("content",e==="light"?G:x)}function ft(){J(),E(),new MutationObserver(e=>{e.forEach(n=>{n.attributeName==="data-theme"&&E()})}).observe(document.body,{attributes:!0})}const K="/api/push/vapid-public",q="/api/push/subscribe",F="/api/push/unsubscribe";async function Y(){const t=await fetch(K);if(!t.ok)throw new Error("VAPID public key not available");const e=await t.json(),n=e.publicKey||e.public_key;if(!n)throw new Error("Invalid VAPID response");return n}function z(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/-/g,"+").replace(/_/g,"/"),a=atob(n),i=new Uint8Array(a.length);for(let r=0;r<a.length;r++)i[r]=a.charCodeAt(r);return i}async function Q(t){const e=await Y(),n=z(e);return await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n})}async function X(t,e=null){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);const a=await fetch(q,{method:"POST",headers:n,body:JSON.stringify(t.toJSON?t.toJSON():t)});if(!a.ok){const i=await a.json().catch(()=>({}));throw new Error(i.message||`Subscribe failed: ${a.status}`)}return a.json()}async function Z(t,e=null){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);const a=await fetch(F,{method:"POST",headers:n,body:JSON.stringify({endpoint:t})});if(!a.ok){const i=await a.json().catch(()=>({}));throw new Error(i.message||`Unsubscribe failed: ${a.status}`)}return a.json()}async function tt(){return"Notification"in self?Notification.permission==="granted"?"granted":Notification.permission==="denied"?"denied":await Notification.requestPermission():"unsupported"}async function pt(t={}){const{getAuthToken:e}=t;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const n=await tt();if(n!=="granted")return{ok:!1,reason:n};try{const a=await navigator.serviceWorker.ready,i=await Q(a),r=typeof e=="function"?await e():null;return await X(i,r),{ok:!0,subscription:i}}catch(a){return console.warn("Push init failed",a),{ok:!1,reason:a.message}}}async function yt(t={}){const{getAuthToken:e}=t;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const a=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!a)return{ok:!0,removed:!1};const i=a.endpoint;try{await a.unsubscribe()}catch{}const r=typeof e=="function"?await e():null;return await Z(i,r).catch(()=>{}),{ok:!0,removed:!0}}async function wt(){return!("serviceWorker"in navigator)||!("PushManager"in window)?!1:!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}export{ot as a,rt as b,W as c,ct as d,lt as e,ut as f,it as g,ft as h,dt as i,wt as j,yt as k,pt as l,st as r,at as s};
