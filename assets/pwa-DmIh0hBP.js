import{o as O}from"./vendor-Dob3nYDb.js";import{s as f,t as r}from"./utils-CITV_lm0.js";const T="studdybuddy",_=`${T}-db`,D=3,L="sync-pending",c=O(_,D,{upgrade(t,e,n){t.objectStoreNames.contains("tasks")||t.createObjectStore("tasks",{keyPath:"_id"}),t.objectStoreNames.contains("dados")||t.createObjectStore("dados",{keyPath:"_id"}),t.objectStoreNames.contains("pendingSync")||t.createObjectStore("pendingSync",{keyPath:"syncId",autoIncrement:!0}).createIndex("byTimestamp","timestamp",{unique:!1})}});async function st(t,e){return(await c).put(t,e)}async function rt(t,e){return(await c).get(t,e)}async function C(t,e){const n=Array.isArray(e)?e:[],i=(await c).transaction(t,"readwrite");await i.store.clear();for(const s of n)await i.store.put(s);await i.done}async function W(t){return(await c).getAll(t)}async function ot(t,e){return(await c).delete(t,e)}async function ct(t){await(await c).add("pendingSync",{type:t.type,url:t.url,body:t.body??null,taskId:t.id??null,headers:t.headers??null,timestamp:Date.now()})}async function j(){return await(await c).getAllFromIndex("pendingSync","byTimestamp")}async function B(t){return(await c).delete("pendingSync",t)}async function M(){const t=new AbortController,e=setTimeout(()=>t.abort(),8e3);try{const n=await fetch("/api/tasks",{signal:t.signal});if(clearTimeout(e),!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json(),i=Array.isArray(a)?a:[];return await C("tasks",i),i}catch(n){return clearTimeout(e),console.error("carregarTasks fetch failed:",n),await W("tasks")}}let b=!1;async function U(){const t=await j();if(t.length!==0)for(const e of t)try{const n=new Headers(e.headers||{});n.has("Content-Type")||n.set("Content-Type","application/json");const a={method:e.type,headers:n};e.body&&(e.type==="POST"||e.type==="PUT")&&(a.body=JSON.stringify(e.body));const i=await fetch(e.url,a);i.ok?await B(e.syncId??e.id):i.status>=400&&i.status<500&&(console.warn(`Sync failed with client error ${i.status}, removing item:`,e),await B(e.syncId??e.id))}catch(n){console.warn("Sync item failed, will retry later:",e,n)}}async function g(){if(b){console.debug("Sync already in progress, skipping");return}b=!0;try{await U(),await M(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("pwa-synced"))}finally{b=!1}}async function dt(){if(typeof navigator>"u"||!navigator.serviceWorker)return;const t=await navigator.serviceWorker.ready;if(!(!t.sync||typeof t.sync.register!="function"))try{await t.sync.register(L)}catch(e){console.warn("Background Sync register failed:",e)}}function lt(){typeof window>"u"||(window.addEventListener("online",()=>{g().catch(()=>{})}),navigator.serviceWorker?.addEventListener("message",t=>{t.data?.type==="SYNC_PENDING"&&g().catch(()=>{})}),navigator.onLine&&g().catch(()=>{}))}const R="/service-worker.js",V="/";function ut(){if(!("serviceWorker"in navigator))return;navigator.serviceWorker.register(R,{scope:V}).then(e=>{console.info("Service Worker registado",e.scope),e.addEventListener("updatefound",()=>{const n=e.installing;n&&n.addEventListener("statechange",()=>{n.state==="installed"&&navigator.serviceWorker.controller&&typeof window.__pwaOnNewVersion=="function"&&window.__pwaOnNewVersion()})})}).catch(e=>console.warn("Erro no registo do Service Worker",e));let t=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{t||(t=!0,window.location.reload())})}const A="pwa-install-dismissed";let l=null,h=!1;const v=new Set;function m(){return typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://")}function I(t){h=!!t,v.forEach(e=>{try{e(h)}catch{}})}function H(t){if(typeof t!="function")return()=>{};v.add(t);try{t(h)}catch{}return()=>v.delete(t)}function $(){try{return localStorage.getItem(A)==="1"}catch{return!1}}function S(){try{localStorage.setItem(A,"1")}catch{}}function x(t){t&&(t.classList.remove("hidden"),t.removeAttribute("hidden"),t.removeAttribute("inert"),t.setAttribute("aria-hidden","false"))}function k(t){t&&(t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),t.setAttribute("inert",""))}async function E({hideBannerId:t}={}){if(!l)return{available:!1,outcome:null};try{l.prompt();const n=(await l.userChoice)?.outcome||null;if(n==="accepted"&&S(),l=null,I(!1),t){const a=document.getElementById(t);k(a)}return{available:!0,outcome:n}}catch(e){return{available:!!l,outcome:null,error:e}}}function ft(t={}){const e=t.bannerId??"pwa-install-banner",n=t.installBtnId??"pwa-install-btn",a=t.closeBtnId??"pwa-install-close";if(typeof window>"u"||m())return;const i=!$();window.addEventListener("beforeinstallprompt",o=>{o.preventDefault(),l=o;const w=document.getElementById(e);I(!0),i&&x(w)});const s=document.getElementById(n);s&&s.addEventListener("click",async()=>{await E({hideBannerId:e})});const u=document.getElementById(a);u&&u.addEventListener("click",()=>{S();const o=document.getElementById(e);k(o)}),window.addEventListener("appinstalled",()=>{S(),l=null,I(!1);const o=document.getElementById(e);k(o)})}function G(){const t=navigator.userAgent||"",e=navigator.platform||"",n=/iPad|iPhone|iPod/.test(t),a=e==="MacIntel"&&navigator.maxTouchPoints>1;return n||a}function p(t,e){t&&(t.textContent=e)}function pt(t={}){const e=t.installBtnId??"pwaInstallNowBtn",n=t.downloadBtnId??"pwaDownloadBtn",a=t.hintId??"pwaInstallHint",i=document.getElementById(e),s=document.getElementById(n),u=document.getElementById(a),o=()=>{i&&(i.disabled=!0,i.hidden=!1,p(i,r("appInstalledBtn"))),s&&(s.disabled=!0),p(u,r("appAlreadyInstalled"))},w=()=>{i&&(i.disabled=!0,i.hidden=!1,p(i,r("appInstall"))),s&&(s.disabled=!1),p(u,r("appInstallHint"))},N=()=>{i&&(i.disabled=!1,p(i,r("appInstall"))),s&&(s.disabled=!1),p(u,r("appInstallReady"))};if(m()){o();return}w(),H(y=>{if(m())return o();y?N():w()}),i?.addEventListener("click",async y=>{y.preventDefault();const d=await E({hideBannerId:"pwa-install-banner"});if(!d.available){s?.click();return}d.outcome==="accepted"?f(r("appInstalled"),"success",3500):d.outcome==="dismissed"&&f(r("appInstallDismissed"),"info",3500)}),s?.addEventListener("click",async y=>{y.preventDefault();const d=await E({hideBannerId:"pwa-install-banner"});if(d.available){d.outcome==="accepted"?f(r("appInstalled"),"success",3500):d.outcome==="dismissed"&&f(r("appInstallDismissed"),"info",3500);return}G()?f(r("appInstallIosHint"),"info",7e3):f(r("appInstallDesktopHint"),"info",7e3)})}const J="#171922",K="#f0f0f4";function q(){typeof document>"u"||(m()?document.documentElement.classList.add("pwa-standalone"):document.documentElement.classList.remove("pwa-standalone"))}function P(){const t=document.querySelector('meta[name="theme-color"]');if(!t)return;const e=document.body.getAttribute("data-theme");t.setAttribute("content",e==="light"?K:J)}function yt(){q(),P(),new MutationObserver(e=>{e.forEach(n=>{n.attributeName==="data-theme"&&P()})}).observe(document.body,{attributes:!0})}const F="/api/push/vapid-public",Y="/api/push/subscribe",z="/api/push/unsubscribe";async function Q(){const t=await fetch(F);if(!t.ok)throw new Error("VAPID public key not available");const e=await t.json(),n=e.publicKey||e.public_key;if(!n)throw new Error("Invalid VAPID response");return n}function X(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/-/g,"+").replace(/_/g,"/"),a=atob(n),i=new Uint8Array(a.length);for(let s=0;s<a.length;s++)i[s]=a.charCodeAt(s);return i}async function Z(t){const e=await Q(),n=X(e);return await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n})}async function tt(t,e=null){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);const a=await fetch(Y,{method:"POST",headers:n,body:JSON.stringify(t.toJSON?t.toJSON():t)});if(!a.ok){const i=await a.json().catch(()=>({}));throw new Error(i.message||`Subscribe failed: ${a.status}`)}return a.json()}async function et(t,e=null){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);const a=await fetch(z,{method:"POST",headers:n,body:JSON.stringify({endpoint:t})});if(!a.ok){const i=await a.json().catch(()=>({}));throw new Error(i.message||`Unsubscribe failed: ${a.status}`)}return a.json()}async function nt(){return"Notification"in self?Notification.permission==="granted"?"granted":Notification.permission==="denied"?"denied":await Notification.requestPermission():"unsupported"}async function wt(t={}){const{getAuthToken:e}=t;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const n=await nt();if(n!=="granted")return{ok:!1,reason:n};try{const a=await navigator.serviceWorker.ready,i=await Z(a),s=typeof e=="function"?await e():null;return await tt(i,s),{ok:!0,subscription:i}}catch(a){return console.warn("Push init failed",a),{ok:!1,reason:a.message}}}async function mt(t={}){const{getAuthToken:e}=t;if(!("serviceWorker"in navigator)||!("PushManager"in window))return{ok:!1,reason:"unsupported"};const a=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!a)return{ok:!0,removed:!1};const i=a.endpoint;try{await a.unsubscribe()}catch{}const s=typeof e=="function"?await e():null;return await et(i,s).catch(()=>{}),{ok:!0,removed:!0}}async function bt(){return!("serviceWorker"in navigator)||!("PushManager"in window)?!1:!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}export{ct as a,ot as b,M as c,lt as d,ft as e,pt as f,rt as g,yt as h,ut as i,bt as j,mt as k,wt as l,dt as r,st as s};
